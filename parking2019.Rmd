---
title: "Untitled"
author: "Putu Wahyu Saputra"
date: "6/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message = FALSE, cache=TRUE)
```

```{r libraries}
library(dplyr)
library(readr)
library(tidyverse)
library(lubridate)
library(tsibble)
library(sugrrants)
library(leaflet)
library(ggmap)
library(here)
library(mapview)
library(broom)
library(rpart.plot)
library(stringr)
```

```{r}
# Questions:
## How to separate date& time with am/pm
## How to convert time to 24-hr format
  separate(ArrivalTime, into = c("arr_date", "arr_time", "arr_pm_am"), sep =" ", extra = "merge")
### How to plot graph with 24-hr format y-axis
### How to plot "Whichever car arrives/departs at a one-hour time frame, count it"
```

```{r read-in, cache = TRUE}
parking2019 <- read.csv(here::here("On-street_Car_Parking_Sensor_Data_-_2019.csv"))
```

```{r}
parking2019_tidy <- parking2019 %>%
  filter(StreetName == "LONSDALE STREET",
         !(is.na(SignPlateID))) %>%  
  select(-DeviceId,
         -StreetMarker,
         -StreetId,
         -BetweenStreet2,
         -BetweenStreet2ID,
         -AreaName) %>%
  separate(ArrivalTime, into = c("arr_date", "arr_time"), sep =" ", extra = "merge") %>% 
  separate(DepartureTime, into = c("dep_date", "dep_time"), sep =" ", extra = "merge")

parking2019_tidy$arr_time <- format(strptime(parking2019_tidy$arr_time, "%I:%M:%S %p"), "%H:%M")
parking2019_tidy$dep_time <- format(strptime(parking2019_tidy$dep_time, "%I:%M:%S %p"), "%H:%M")

# Format date variables from CHAR to DATE 
parking2019_tidy$arr_date <- mdy(parking2019_tidy$arr_date)
parking2019_tidy$dep_date <- mdy(parking2019_tidy$dep_date)

# Extract hour& minutes 
parking2019_tidy$arr_hour <- format(as.POSIXct(parking2019_tidy$arr_time,format="%H:%M"),"%H")
parking2019_tidy$arr_min <- 
format(as.POSIXct(parking2019_tidy$arr_time,format="%H:%M"),"%M")
parking2019_tidy$dep_hour <- format(as.POSIXct(parking2019_tidy$dep_time,format="%H:%M"),"%H")
parking2019_tidy$dep_min <- format(as.POSIXct(parking2019_tidy$arr_time,format="%H:%M"),"%M")
parking2019_tidy$arr_time <- format(as.POSIXct(parking2019_tidy$arr_time,format="%H:%M"),"%H: %M")
parking2019_tidy$dep_time <- format(as.POSIXct(parking2019_tidy$dep_time,format="%H:%M"),"%H: %M")
```

```{r read-in-tidy-data, cache = TRUE}
parking2019_tidy <- write_csv(parking2019_tidy, "parking2019_tidy.csv")
```

```{r summary-violations}
summ_parking2019_vio <- parking2019_tidy %>%
  group_by(InViolation) %>%
  summarise(total = sum(n()))
```

Facts:
> Parking Services Officers may mark the tire of a vehicle parked in a time-restricted area& come back as soon as you overstay the time restriction.
> Inside Melbourne CBD, the parking fees for on street-parking is [$7/hr](https://www.melbourne.vic.gov.au/parking-and-transport/parking/parking-locations-fees/Pages/parking-locations-and-fees.aspx).

Data:
> In 2019, a total of 249,216 instances where a car parked& departed.
> Of this, 10,191 (2.918%) violated the restriction.
* This proportion may seem little, but parking fines are on average, [$124](https://www.melbourne.vic.gov.au/parking-and-transport/parking/parking-fines/Pages/default.aspx#:~:text=Penalty%20amounts%E2%80%8B,State%20Government%20and%20increase%20annually.) when you overstay! $`r 124*summ_parking2019_vio[,2]` were paid just for the fines in Lonsdale Street!


# Along Lonsdale Street, which locations do most vehicles overstay in?

```{r parking-violation}
parking2019_vio <- parking2019_tidy %>%
  filter(InViolation == "true")
```

```{r}
parking2019_vio %>%
  group_by(BetweenStreet1) %>%
  summarise(n = n()) %>%
  arrange(desc(n))
```

* Out of the all five streets, Exhibition Street had the most number of vehicles which violated the time restriction.
* Exhibition St and Russel St are actually right next to one another! What do they have in common? (*elaborate*) - many rooftop bars etc.

```{r}
parking2019_vio %>%
  group_by(BetweenStreet1, Sign) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  head(10)
```

* We'd expect more vehicles to overstay in parking lots with a shorter time frame
* BUT, most vehicles overstayed in where the time restrictions were 2 hours

# Analysis 1: Arrival& Departure times of cars that overstayed
```{r}
parking2019_vio %>%
  # Retrieve day of the week
  mutate(arr_day = wday(arr_date, label = TRUE),
         dep_day = wday(dep_date, label = TRUE)) %>%
  mutate()
```


# Analysis 2: Avg. time overstayed for each sign
```{r}
unique(parking2019_vio$Sign)

parking2019_vio %>%
  group_by(Sign, BetweenStreet1) %>%
  summarise(n = n())
```

```{r}
parking2019_vio <- parking2019_vio %>%
  # Extract specfic signs, assign them according to minutes
  mutate(restrict_mins = case_when(
    str_starts(Sign, "1/2 P") ~ 30, 
    str_starts(Sign, "1P") ~ 60,
    str_starts(Sign, "2P") ~ 120
    ),
    # Compute amount of mins overstayed
    overstay_mins = DurationMinutes - restrict_mins)
```

```{r}
library(ggridges)
ggplot(parking2019_vio) +
  geom_density_ridges(
    aes(
      x = overstay_mins,
      y = factor(restriction),
      fill = factor(restriction)
    ),
    alpha = 0.6,
    stat = "binline",  
    bins = 30) +
  # Edit x-axis, 0-100 separated by sequence of 'tens' 
  ## Edit x-axis, 100 - 600 by sequences of '50' 
  facet_wrap(~ BetweenStreet1) +
  scale_fill_manual(values = c("#663300", "#006633","#330066")) +
  labs(x = "Minutes overstayed", y = "") +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(legend.position="none")
```

* No vehicles overstayed in the 1/2P signs in Queen St, Exhibition St& William St.
*


